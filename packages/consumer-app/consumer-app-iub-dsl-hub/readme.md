- [ ] 系统设计方案制定前：是否有对A/B方案进行优缺点对比和决策
- [x] 是否有业务领域模型
- [x] 是否有系统领域模型（包含用例图）
- [ ] 是否有系统物理部署架构图
- [x] 是否有系统分层架构
- [x] 是否有核心接口分层架构图
- [x] 是否有核心接口UML图及说明
- [ ] 是否有核心业务处理时序图（包括业务流程&核心功能处理）
- [x] 是否有代码工程项目结构
- [x] 是否有业务核心痛点解决方案
- [x] 是否有核心性能痛点解决方案
- [x] 是否有核心安全痛点解决方案
- [x] 是否符合高内聚、低耦合的要求
- [x] 是否有足够的扩展性
- [ ] 功能分解是否完整
- [x] 是否对兼容性进行考虑
- [x] 是否对稳定性进行考虑
- [x] 是否对可维护性进行考虑
- [x] 是否有完整的需求双向跟踪表（需求开发<->架构设计<->概要设计）【模块级】
- [x] 是否有文档变更记录，是否完整

-----

[[toc]]

# IUB-DSL工作原理详细设计

-----

## 1. Changelog

| 作者 | 更新日期 | 版本 | 备注 |
|---|---|---|---|
| 相杰 | 2020-06-15 | v0.0.1 | 初稿 |
| 相杰 | 2020-06-22 | v1.0.0 | 1. 修改页面间交互时序图 <br> 2. 添加更详细的 IUB-DSL 业务领域模型图 <br> 3. 添加更详细的名词解释 <br> 4. 工作原理图添加数据变更时通知接口的链路 |
| 相杰 | 2020-07-04 | v1.1.0 | 1. 根据架构设计 v3 调整文档内容 <br> 2. 根据统一的术语调整文档内容 |

## 2. 引言

我们尝试建立一套通用的 `DSL` 模型，尽可能描述 `80%` 的通用业务，剩余的需求通过更高阶的实现进行扩展，从而完成「`业务可视化生成器`」，达到`提高生产力`的目标。

-----

## 3. 背景

低代码平台是`高生产力`的工具的代表之一，也是技术改革生产关系的未来发展的方向之一。为了构建一个运行良好、易于扩展、维护的低代码平台，来支持未来无限的业务场景，于是建立了 `IUB-DSL` 模型，来支持低代码系统的运行。

## 4. 编写目的和范围

- 验证 IUB-DSL 的可行性
  - IUB-DSL 的设计思路
  - IUB-DSL 的工作原理
- 说明 IUB-DSL 的系统体系
  - 指导其他模块的设计

-----

## 5. 需求对应范围

![图片描述](/tfl/pictures/202006/tapd_41909965_1592554307_80.png)

-----

## 6. IUB-DSL 定义（Definition）

Interaction between User and Business DSL（IUB-DSL）：用户与业务的交互 - DSL。

主要用于「描述」用户如何与业务交互，具体体现为 `UI 如何布局`、`权限如何流转`、`数据之间的关系`等。

IUB-DSL 本质上是 `js`，在这基础上按照 `AST` 的规则，每个节点都由 `type` 进行描述。基于此前提，将「布局」与「业务」分别抽离，用 IUB-DSL 模型来描述整条业务链的关系。

名词解释：

- AST：抽象语法树，用于表示程序的源代码结构。这里用于描述业务的抽象结构。
- 上下文 context：程序运行过程中产生的变量逻辑运行环境。
- 应用运行容器：用于支撑应用平台的运行，以及页面之间的交互。

参考：

- [AST 规则说明](https://thinkmore.xyz/Babel%E6%8F%92%E4%BB%B6%E6%89%8B%E5%86%8C(%E6%A0%BC%E5%BC%8F%E4%BF%AE%E6%AD%A3)/#toc-asts)
- [IUB-DSL 定义](https://github.com/SANGET/custom-platform-tool/blob/master/packages/iub-dsl/core/types/page/page.ts)
- [IUB-DSL 属性思维导图](https://www.tapd.cn/41909965/documents/view/1141909965001001059?file_type=mindmap&amp;amp;amp;amp;file_ext=xmind)

-----

## 7. 设计（Design）

### 7.1. IUB-DSL 设计思路

#### 7.1.1. 一

1. 将「`业务`」按照一定的数据结构拆分成不同的 `IUB-DSL 节点`进行描述
2. 通过规定`节点之间的关联关系`，保证 IUB-DSL 对业务的描述的完整性
3. 每个节点都是`单一职能`，可以通过其中的节点关系满足业务扩展的需求

#### 7.1.2. 二

IUB-DSL 的核心是「`数据`」，围绕「`数据`」的变化（何时变化、如何变化、如何体现变化 -> 渲染页面）链路，制定变化规则，可用于满足大部分业务场景，作为系统的运转核心和依据。

通过将业务数据流向的抽象，抽离出`结构化`的数据节点，各个节点产生对应的关联，保证数据的变化和流动的方向的正确性，让系统容易扩展和维护。

#### 7.1.3. 三

透过现象看本质：

- 表征为控件与控件之间的联动，控件订阅另一个控件的变化，从而再根据一定规则变化自身数据。
- 但本质上是数据之间的变化，是一个数据的变化要影响另一个数据，然后将变化渲染给用户感知。
- 所以 IUB-DSL 抽离了一层数据，控件只是用来做显示和触发改变数据的动作的一个载体。

### 7.2. IUB-DSL 业务领域模型

可视化生产工具是一种典型的`生产与消费`模式，我们将配置平台视为`生产者`，应用平台视为`消费者`，产物便是 `IUB-DSL` 静态数据。

![图片描述](/tfl/pictures/202007/tapd_41909965_1594174814_74.png)

-----

可视化编辑器产出的页面布局信息以及对应的控件的属性，通过一个 `IUB-DSL 转换器` 转换成 IUB-DSL 数据，最终交给应用平台运行，支撑业务。

![图片描述](/tfl/pictures/202007/tapd_41909965_1594202956_16.png)
名词解释：

- 控件属性：配置平台中的控件的属性，这些属性按照一定的规则和关系，分拆到不同的 IUB-DSL 节点中描述存储。

### 7.3. IUB-DSL 各模块关系

以下为围绕 IUB-DSL 延伸的系统模块关系图：

![图片描述](/tfl/pictures/202007/tapd_41909965_1594109450_29.png)

### 7.4. IUB-DSL 运行模型

以下为 IUB-DSL 运行模型，运行链路为：`应用运行容器` -> `页面运行容器` -> `IUB-DSL 引擎`：

![图片描述](/tfl/pictures/202007/tapd_41909965_1593853679_59.png)

名词解释：

- 前端系统元配置数据：应用的默认配置信息，以及数据处理流程中的默认数据获取链路。
- 数据交换中枢：是 IUB-DSL 引擎的职责。

-----

## 8. IUB-DSL 工作流（IUB-DSL work flow）

结合`应用运行容器`、`页面运行容器`，我们深入 `IUB-DSL 引擎`，探索其工作流，同时为 `IUB-DSL 运行模型`提供可行性的验证：

![图片描述](/tfl/pictures/202007/tapd_41909965_1593912690_49.png)

名词解释：

- 前端应用配置元数据：应用的默认配置信息，以及数据处理流程中的默认数据获取链路。
- 运行时上下文：存储对应的容器运行时状态的对象，用于作用域隔离。

### 8.1. 应用运行容器

整个应用平台前端运行容器，用于支撑系统运行，提供`页面之间的数据调度`，运行时提供`系统运行时上下文`（system runtime context简称 SysRtCtx）。

### 8.2. 页面运行容器

用于根据页面类型（配置、定制）的不同而选择不同页面加载方式的容器，运行时提供`页面运行时上下文`（page runtime context 简称 PgRtCtx）。

#### 8.2.1. 页面之间的通讯

在`应用运行容器`中，「`页面`」之间的关系是平行的，无论是`内嵌页面`还是`弹窗页面`：

![图片描述](/tfl/pictures/202006/tapd_41909965_1592791038_19.png)

为了实现页面之间的解藕以及通讯，我们采用`订阅发布模式`，统一由「`应用运行容器 - 数据调度器`」提供`页面数据变化`的订阅服务。

关系图如下：

![图片描述](/tfl/pictures/202006/tapd_41909965_1592484088_70.png)

由上图整理的页面之间通讯时序图：

![图片描述](/tfl/pictures/202006/tapd_41909965_1592791057_87.png)

名词解释：

- 实例引用：页面引用其他页面实例的凭证，用于后续操作。

### 8.3. IUB-DSL 引擎

解析并执行 IUB-DSL 的模块，最终会输出与用户交互的 `UI`。产生的数据通过`页面运行容器`处理。

#### 8.3.1. 流程运行容器

IUB-DSL 引擎内的运行容器，当数据发生更改时，用于运算数据更改事务的容器。运行时提供`流程运行时上下文`（flow runtime context 简称 FlRtCtx）。

-----

### 8.4. 运行容器之间的交互关系和规则

- 运行容器工作时数据传递由上到下，不允许跨级通讯。
- `页面运行容器` 是平行关系，统一由 `应用运行容器` 调度数据。
- `流程运行容器` 在 `页面运行容器` 之中，是业务运行时的数据流转载体，具备事务性质。

### 8.5. 运行时产生的数据的规则

- 每一个数据字段都有一个页面内唯一 ID。
- 需要引用数据的地方只需要引用数据的 ID 即可。
- 只有一个元数据映射与真实数据表有关联，统一出入口。

通过上述规则，加上数据的单向流动，确保数据最终的一致性。

-----

## 9. 定制接入

### 9.1. 定制页面

- 通过 IUB-DSL 描述定制页面的元数据信息
- 定制开发者通过定制接入标准开发。最终的目标是在自定义平台中内置 web IDE（在线 vscode），web IDE 提供完整的开发依赖。

![图片描述](/tfl/pictures/202006/tapd_41909965_1592617811_41.jpg)

### 9.2. 定制组件

同定制页面

-----

## 10. 非功能性需求

### 10.1. 扩展性、兼容性

IUB-DSL 实际上是定义一种数据运行规则，符合「微内核引擎 -> 插件 -> 业务插件」的插件系统设计思路。

当我们了解了 IUB 中每个功能节点的职能，以及节点与节点之间的关系之后，扩展是很容易的，只需要在对应节点继续添加节点，以及对应的节点解析器即可。扩展的节点集中在「关系集合」与「动作集合」之中。可扩展性也是在这一点上得到体现。

由于是通过节点的增量来满足未来需求，「向前兼容」也得到了保证。

### 10.2. 可维护性

由于 IUB-DSL 是一份规范、生成的系统的运行依据。通过图示和 Typescript 的 interface 来确保 IUB-DSL 的稳定和可维护性。

### 10.3. 稳定性

IUB-DSL 数据处理方式是基于「数据管道 pipe（单向数据流）」的，数据管道确保了数据变化的顺序、流动方向，以及数据的变化跟踪的运作，从而体现系统稳定性。

### 10.4. 系统性能

由于系统都是由多个独立模块通过关系组合而成，如果遇到性能问题，可以方便定位性能瓶颈，从而找到更合适的性能解决方案。

### 10.5. 核心安全

IUB-DSL 的运行时数据是统一存放以及处理的，所以可以轻松在数据读写的模块加入加密算法，保障系统数据安全。

-----

## 11. IUB-DSL 工程设计（Design of engineering）

### 11.1. 接口规范（IUB-DSL interface spec）

```ts
interface TypeOfIUBDSL {
  /** 页面 ID，用于给其他页面引用 */
  id: string;

  /** 页面类型 */
  type: PageTypes;

  /** 页面名称 */
  name: string;

  /** 与 system runtime context 的接口 */
  sysRtCxtInterface: SRCInterface;

  /** Schema 数据模型 */
  schemas: {
    page: PageSchemas;
    flow: FlowSchemas;
  };

  /** 元数据映射集合 [数据源关系枢纽] */
  metadataCollection: MetadataMappingCollection;

  /** 关系集合 */
  relationshipsCollection: RelationshipsCollection;

  /** 组件集合 */
  componentsCollection: {
    [componentID: string]: ComponentElement;
  };

  /** 动作集合 */
  actionsCollection: {
    [actionID: string]: ActionFlow;
  };

  /** 布局信息 */
  layoutContent: LayoutContentGeneral | LayoutContentCustom;
}
```

### 11.2. 系统目录结构（Project files structure）

- iub-dsl
  - core 定义核心接口
  - parser 核心模块解析器
  - runtime 解析结果的运行时模块
  - demo 存放场景用例
  - docs 存放文档

-----

## 12. 业务痛点

### 12.1. 规范

过去的 2.x 平台的数据变化规则并不够明确，所有的数据变化关系都围绕「控件」之间的订阅发布来处理，而且缺乏变化的链路标准，缺少恒之有道的可扩展模型。所以导致随着业务场景的增加，系统越发难以承受和扩展。

### 12.2. 便于业务扩展

这就是 IUB-DSL 需要解决的问题：制定一个可控可靠的数据变化标准，建立一套易于扩展、维护的体系，让一切的系统变化有根可循，从而更容易应对未来的变化。

-----

## 13. 参考（Reference）

- [前端系统架构](https://www.tapd.cn/41909965/documents/show/1141909965001001142#target:toc4)
- [IUB-DSL 项目结构](https://github.com/SANGET/custom-platform-tool/tree/master/packages/iub-dsl)
- [真实业务场景 - 新增用户](https://github.com/SANGET/custom-platform-tool/blob/master/packages/iub-dsl/demo/business-case/create-user.ts)
- [IUB-DSL 属性思维导图](https://www.tapd.cn/41909965/documents/view/1141909965001001059?file_type=mindmap&amp;amp;amp;amp;amp;file_ext=xmind)

-----

IUB-DSL 工作流完整版

![图片描述](/tfl/pictures/202007/tapd_41909965_1593912645_47.png)

-----

IUB-DSL 模型完整版

![图片描述](/tfl/pictures/202007/tapd_41909965_1593854836_7.png)
